import os
import sys
import asyncio
import tempfile
from pathlib import Path
import subprocess

try:
    from PIL import Image, ImageDraw, ImageFont
except Exception as e:
    print("Pillow is required. Install with: pip install Pillow")
    raise

try:
    from moviepy.editor import ImageClip, AudioFileClip, concatenate_videoclips, CompositeVideoClip
except Exception as e:
    print("moviepy is required. Install with: pip install moviepy")
    raise

# market data & plotting deps
try:
    import yfinance as yf
    import pandas as pd
    import matplotlib
    matplotlib.use('Agg')
    import matplotlib.pyplot as plt
    from matplotlib.dates import DateFormatter
except Exception:
    # we'll surface errors at runtime if plotting is attempted without deps
    yf = None
    pd = None
    plt = None

# Helper: run Ollama if available
def ollama_generate(prompt: str, model: str = "qwen2.5:1.5b", timeout: int = 15) -> str:
    """Generate text using local Ollama if available. Returns generated text or original prompt on failure.

    Uses `ollama run MODEL PROMPT --format json` when possible. If the Ollama server is not running or the call fails,
    this function returns the original prompt as a graceful fallback.
    """
    import subprocess, json
    try:
        # Use `ollama run` which requires a running Ollama server (ollama serve)
        proc = subprocess.run(["ollama", "run", model, prompt, "--format", "json"], capture_output=True, text=True, timeout=timeout)
        if proc.returncode == 0:
            out = proc.stdout.strip()
            try:
                data = json.loads(out)
                # Try common json structures
                if isinstance(data, dict):
                    # try content or text fields
                    for key in ("content", "text", "response", "answer"):
                        if key in data and isinstance(data[key], str):
                            return data[key].strip()
                    # try nested 'choices' like structures
                    if 'choices' in data and isinstance(data['choices'], list) and data['choices']:
                        first = data['choices'][0]
                        if isinstance(first, dict) and 'content' in first:
                            return first['content'].strip()
                # fallback: return raw stdout
                return out or prompt
            except Exception:
                return out or prompt
        else:
            # If server not responding or other error, attempt without json flag
            proc2 = subprocess.run(["ollama", "run", model, prompt], capture_output=True, text=True, timeout=timeout)
            if proc2.returncode == 0:
                return proc2.stdout.strip() or prompt
            # If server not running, bail gracefully
            return prompt
    except Exception:
        return prompt


def is_ollama_running(model: str = "qwen2.5:1.5b", timeout: int = 6) -> tuple[bool, str]:
    """Check whether the local Ollama server responds for a quick run (returns (ok, message))."""
    import subprocess
    try:
        proc = subprocess.run(["ollama", "run", model, "Ping.", "--format", "json"], capture_output=True, text=True, timeout=timeout)
        if proc.returncode == 0:
            return True, "Ollama responded"
        else:
            return False, proc.stderr.strip() or proc.stdout.strip()
    except Exception as e:
        return False, str(e)


def prefetch_piper_voices(voices: list[str], cache_dir: str = "out_smoke/piper_models") -> dict:
    """Attempt to download and cache Piper voice models. Returns status dict voice->(ok, msg)."""
    results = {}
    for v in voices:
        try:
            path = _ensure_piper_voice(v, cache_dir)
            results[v] = (True, f"Cached at {path}")
        except Exception as e:
            results[v] = (False, str(e))
    return results


def start_ollama_serve(logfile: str = "out_smoke/ollama_serve.log") -> tuple[bool, str]:
    """Attempt to start `ollama serve` in background and return (ok, message).

    This is opt-in and best-effort; it will spawn a background process and write a PID file `out_smoke/ollama.pid`.
    """
    import subprocess, time
    pidfile = Path("out_smoke/ollama.pid")
    if pidfile.exists():
        try:
            existing_pid = int(pidfile.read_text())
            # Check if process exists
            os.kill(existing_pid, 0)
            return True, f"Ollama serve already running (pid {existing_pid})"
        except Exception:
            pidfile.unlink()
    try:
        logf = open(logfile, 'a')
        proc = subprocess.Popen(["ollama", "serve"], stdout=logf, stderr=logf)
        # write pid
        pidfile.write_text(str(proc.pid))
        # wait briefly for server to come up
        time.sleep(1.5)
        ok, msg = is_ollama_running()
        if ok:
            return True, f"Started ollama serve (pid {proc.pid})"
        else:
            return False, f"Started process but Ollama not responding yet: {msg} (Check {logfile})"
    except Exception as e:
        return False, str(e)


def stop_ollama_serve() -> tuple[bool, str]:
    """Stop a previously started ollama serve process (opt-in)."""
    pidfile = Path("out_smoke/ollama.pid")
    if not pidfile.exists():
        return False, "No pidfile found"
    try:
        pid = int(pidfile.read_text())
        os.kill(pid, 15)
        pidfile.unlink()
        return True, f"Stopped ollama serve (pid {pid})"
    except Exception as e:
        return False, str(e)


def ollama_rewrite_for_duration(script_text: str, target_seconds: int = 52, model: str = "qwen2.5:1.5b") -> str:
    """Ask Ollama to rewrite or condense a script to roughly match a target spoken duration.

    If Ollama is unavailable, return the original script.
    """
    prompt = (
        f"Rewrite the following script to be approximately {target_seconds} seconds when spoken at normal pace. "
        "Keep the meaning, use short sentences, and preserve the scene-by-scene structure. Return only the rewritten script text."\
        f"\n\nScript:\n{script_text}"
    )
    return ollama_generate(prompt, model=model, timeout=20)

# Try lightweight TTS options: edge-tts (preferred), fallback to pyttsx3
EDGE_AVAILABLE = False
PYTTSX3_AVAILABLE = False

try:
    import edge_tts
    EDGE_AVAILABLE = True
except Exception:
    EDGE_AVAILABLE = False

# global flag to avoid repeating Piper download attempts when it's failing
PIPER_BROKEN = False  # flip to True if Piper download/generation fails repeatedly

try:
    import pyttsx3
    PYTTSX3_AVAILABLE = True
except Exception:
    PYTTSX3_AVAILABLE = False


def ensure_dirs():
    out_dir = Path("out_smoke")
    out_dir.mkdir(parents=True, exist_ok=True)
    return out_dir


async def _edge_tts_save(text: str, out_path: str, voice: str = "en-US-GuyNeural"):
    # edge-tts saves using an async API
    communicate = edge_tts.Communicate(text, voice)
    await communicate.save(out_path)


def _ensure_piper_voice(voice: str, download_dir: str):
    """Ensure the Piper voice model is downloaded into download_dir. Returns model path or raises.

    First check for an existing model file to avoid re-downloading repeatedly.
    """
    import subprocess
    d = Path(download_dir)
    d.mkdir(parents=True, exist_ok=True)
    # if models already exist, return the first one
    models = list(d.glob("**/*.onnx"))
    if models:
        return str(models[0])
    # Attempt to run piper.download (module) which some piper installations expose
    try:
        subprocess.run([sys.executable, "-m", "piper.download", "--voice", voice, "--output_dir", str(d)], check=True, capture_output=True, text=True, timeout=300)
    except Exception:
        # Some piper installs use different module names; try best-effort CLI
        try:
            subprocess.run([sys.executable, "-m", "piper", "download", "--voice", voice, "--output_dir", str(d)], check=True, capture_output=True, text=True, timeout=300)
        except Exception as e:
            raise RuntimeError(f"Piper voice download failed: {e}")
    # find any model file (.onnx) in download_dir
    models = list(d.glob("**/*.onnx"))
    if not models:
        raise RuntimeError(f"Piper voice model not found after download in {download_dir}")
    return str(models[0])


def _piper_save(text: str, out_path: str, voice: str, cache_dir: str = "out_smoke/piper_models"):
    """Generate audio using Piper CLI (python -m piper). Returns path to generated wav.

    This attempts to download the voice model if missing, then calls piper to produce a wav file.
    """
    import subprocess
    import tempfile
    txt = tempfile.NamedTemporaryFile(delete=False, suffix=".txt")
    txt.write(text.encode("utf-8"))
    txt.close()
    out_wav = str(Path(out_path).with_suffix('.wav'))
    try:
        # Ensure voice model
        model_path = _ensure_piper_voice(voice, cache_dir)
        # Run piper to synthesize
        cmd = [sys.executable, "-m", "piper", "--model", str(model_path), "--text-file", txt.name, "--output-file", out_wav]
        subprocess.run(cmd, check=True, capture_output=True, text=True, timeout=120)
        return out_wav
    except Exception as e:
        try:
            os.unlink(txt.name)
        except Exception:
            pass
        raise RuntimeError(f"Piper TTS generation failed: {e}")


def tts_generate(text: str, out_path: str, tts_engine: str = "auto", piper_voice: str = "en_US-lessac-medium"):
    """Generate TTS audio at out_path.

    tts_engine: 'piper', 'edge', 'pyttsx3', or 'auto' (prefer piper -> edge -> pyttsx3)
    Returns a WAV path if possible, else whatever was produced.
    """
    engine = tts_engine
    if engine == "auto":
        engine = "piper"

    if engine == "piper":
        if PIPER_BROKEN:
            print("Skipping Piper (previous failure recorded); falling back to edge-tts/pyttsx3")
        else:
            print(f"Using Piper TTS (voice={piper_voice}) if available")
            try:
                wav = _piper_save(text, out_path, piper_voice)
                return wav
            except Exception as e:
                print("Piper failed, falling back to edge-tts or pyttsx3:", e)
                # mark Piper as broken to avoid repeating heavy download attempts
                globals()['PIPER_BROKEN'] = True
            # fall through to Edge

    if EDGE_AVAILABLE:
        print("Using edge-tts for TTS output (lightweight client)")
        # Edge saves to mp3; create a wav out if requested
        try:
            # if out_path expects .wav, save to temp mp3 then convert
            tmp_mp3 = str(Path(out_path).with_suffix('.mp3'))
            # run async edge-tts in the same robust way as before
            try:
                loop = asyncio.get_running_loop()
                loop_running = True
            except RuntimeError:
                loop_running = False
            if not loop_running:
                asyncio.get_event_loop().run_until_complete(_edge_tts_save(text, tmp_mp3))
            else:
                import threading
                def _run_in_thread():
                    asyncio.run(_edge_tts_save(text, tmp_mp3))
                t = threading.Thread(target=_run_in_thread)
                t.start()
                t.join()
            # convert mp3 to wav if requested
            if str(out_path).endswith('.wav'):
                try:
                    from pydub import AudioSegment
                    AudioSegment.from_file(tmp_mp3).export(out_path, format='wav')
                    os.remove(tmp_mp3)
                    return out_path
                except Exception:
                    # fallback: return mp3
                    return tmp_mp3
            return tmp_mp3
        except Exception as e:
            print("edge-tts failed:", e)
    if PYTTSX3_AVAILABLE:
        print("edge-tts not available; using pyttsx3 fallback (local)")
        engine = pyttsx3.init()
        engine.save_to_file(text, out_path)
        engine.runAndWait()
        return out_path
    raise RuntimeError("No TTS engine available. Install piper, edge-tts or pyttsx3.")


def _fetch_history(ticker: str, period: str = "5d", interval: str = "15m"):
    if yf is None:
        raise RuntimeError("yfinance/matplotlib are required for plotting. Install yfinance and matplotlib")
    df = yf.Ticker(ticker).history(period=period, interval=interval)
    if df.empty:
        raise RuntimeError(f"No data for {ticker} (period={period}, interval={interval})")
    return df


def plot_spy_qqq(spy_df, qqq_df, out_path, size=(540, 960)):
    """Create side-by-side SPY and QQQ candlestick-like charts and highlight last candle."""
    fig, axes = plt.subplots(2, 1, figsize=(size[0]/100, size[1]/200), constrained_layout=True)
    for ax, df, title in ((axes[0], spy_df, "SPY"), (axes[1], qqq_df, "QQQ")):
        ax.plot(df.index, df['Close'], color='#87CEFA')
        ax.fill_between(df.index, df['Low'], df['High'], color='#1f1f1f', alpha=0.05)
        # highlight last candle
        last = df.iloc[-1]
        ax.scatter([df.index[-1]], [last['Close']], color='#ffcc00', s=60, zorder=5)
        ax.set_title(title, color='white')
        ax.tick_params(colors='white')
        ax.set_facecolor('#08141A')
    fig.patch.set_facecolor('#08141A')
    plt.savefig(out_path, facecolor=fig.get_facecolor(), dpi=100)
    plt.close(fig)
    return out_path


def plot_vix(vix_df, out_path, size=(540, 960)):
    """Line chart of VIX with shade above recent average"""
    fig, ax = plt.subplots(1, 1, figsize=(size[0]/100, size[1]/200))
    ax.plot(vix_df.index, vix_df['Close'], color='#f39c12')
    ma = vix_df['Close'].rolling(5, min_periods=1).mean()
    ax.fill_between(vix_df.index, ma, vix_df['Close'], where=(vix_df['Close'] >= ma), color='red', alpha=0.15)
    ax.set_title('VIX', color='white')
    ax.tick_params(colors='white')
    ax.set_facecolor('#08141A')
    fig.patch.set_facecolor('#08141A')
    plt.savefig(out_path, facecolor=fig.get_facecolor(), dpi=100)
    plt.close(fig)
    return out_path


def plot_single(df, title, out_path, size=(540, 960)):
    fig, ax = plt.subplots(1, 1, figsize=(size[0]/100, size[1]/200))
    ax.plot(df.index, df['Close'], color='#87CEFA')
    ax.set_title(title, color='white')
    ax.tick_params(colors='white')
    ax.set_facecolor('#08141A')
    fig.patch.set_facecolor('#08141A')
    plt.savefig(out_path, facecolor=fig.get_facecolor(), dpi=100)
    plt.close(fig)
    return out_path


def make_scene_image(lines, size=(720, 1280), bg_color=(8, 12, 22), text_color=(240, 240, 240), footer=None, font_path=None, filename=None):
    """Create a simple image with the provided lines centered vertically."""
    img = Image.new("RGB", size, color=bg_color)
    draw = ImageDraw.Draw(img)

    # Try to pick a reasonable font size; fallback to default font
    try:
        if font_path and Path(font_path).exists():
            title_font = ImageFont.truetype(font_path, 64)
            body_font = ImageFont.truetype(font_path, 44)
            small_font = ImageFont.truetype(font_path, 28)
        else:
            title_font = ImageFont.truetype("DejaVuSans-Bold.ttf", 64)
            body_font = ImageFont.truetype("DejaVuSans.ttf", 44)
            small_font = ImageFont.truetype("DejaVuSans.ttf", 28)
    except Exception:
        title_font = None
        body_font = None
        small_font = None

    w, h = size
    # render lines centered
    total_h = 0
    line_sizes = []
    # helper to compute text size in a PIL-version-robust way
    def _text_size(draw_obj, text_str, font_obj=None):
        try:
            # newer PILs support draw.textbbox or draw.textsize with font
            if font_obj is not None:
                try:
                    return draw_obj.textsize(text_str, font=font_obj)
                except Exception:
                    pass
            else:
                try:
                    return draw_obj.textsize(text_str)
                except Exception:
                    pass
            # fallback to font.getsize
            if font_obj is not None:
                try:
                    return font_obj.getsize(text_str)
                except Exception:
                    pass
            # final fallback using textbbox
            bbox = draw_obj.textbbox((0, 0), text_str, font=font_obj)
            return (bbox[2] - bbox[0], bbox[3] - bbox[1])
        except Exception:
            # worst-case fallback
            return (len(text_str) * 8, 16)

    for i, (text, is_title) in enumerate(lines):
        font = title_font if is_title else body_font
        tw, th = _text_size(draw, text, font)
        line_sizes.append((tw, th, font))
        total_h += th + 10

    cur_y = (h - total_h) // 2
    for (text, is_title), (tw, th, font) in zip(lines, line_sizes):
        x = (w - tw) // 2
        if font:
            draw.text((x, cur_y), text, fill=text_color, font=font)
        else:
            draw.text((x, cur_y), text, fill=text_color)
        cur_y += th + 10

    # footer
    if footer:
        try:
            if small_font:
                tw, th = _text_size(draw, footer, small_font)
                draw.text(((w - tw) // 2, h - th - 24), footer, fill=(200, 200, 200), font=small_font)
            else:
                tw, th = _text_size(draw, footer, None)
                draw.text(((w - tw) // 2, h - th - 24), footer, fill=(200, 200, 200))
        except Exception:
            pass

    if filename:
        img.save(filename)
        return filename
    else:
        tmp = tempfile.NamedTemporaryFile(delete=False, suffix=".png")
        img.save(tmp.name)
        return tmp.name


def _make_subtitle_clips(srt_entries, video_size, fps):
    """Create MoviePy ImageClips for each SRT entry by rendering text with PIL to avoid ImageMagick dependency."""
    from moviepy.editor import ImageClip
    from PIL import Image, ImageDraw, ImageFont
    subs = []
    w, h = video_size
    # choose font (smaller than before so subtitles don't compete with bottom caption)
    try:
        font = ImageFont.truetype("DejaVuSans.ttf", 22)
    except Exception:
        font = ImageFont.load_default()
    for entry in srt_entries:
        txt = entry['text']
        start = entry['start']
        end = entry['end']
        duration = end - start
        # wrap text to width using a temporary draw to measure text
        margin = int(w * 0.06)
        max_w = w - margin * 2
        lines = []
        words = txt.split()
        cur = ""
        # create a temporary image to measure text
        tmp_img = Image.new('RGBA', (w, 1000), (0, 0, 0, 0))
        tmp_draw = ImageDraw.Draw(tmp_img)
        for w2 in words:
            test = cur + (" " if cur else "") + w2
            size_test = tmp_draw.textsize(test, font=font)
            if size_test[0] > max_w and cur:
                lines.append(cur)
                cur = w2
            else:
                cur = test
        if cur:
            lines.append(cur)
        # measure height
        line_h = tmp_draw.textsize("Ay", font=font)[1] + 6
        img_h = line_h * len(lines) + 16
        # slightly transparent background so subtitles sit above graphs but below bottom caption
        img = Image.new("RGBA", (w, img_h), (8, 12, 22, 200))
        draw = ImageDraw.Draw(img)
        y = 10
        for line in lines:
            tw, th = draw.textsize(line, font=font)
            draw.text(((w - tw) // 2, y), line, font=font, fill=(255, 255, 255, 255))
            y += line_h
        tmp = tempfile.NamedTemporaryFile(delete=False, suffix='.png')
        img.save(tmp.name)
        # place subtitles above the bottom caption area (leave room for caption bar)
        clip = ImageClip(tmp.name).set_start(start).set_duration(duration).set_position(('center', h - img_h - 120))
        subs.append(clip)
    return subs


def _srt_from_scenes(scene_texts):
    """Create SRT entries from list of (start, end, text) tuples."""
    entries = []
    idx = 1
    for start, end, text in scene_texts:
        entries.append({'idx': idx, 'start': start, 'end': end, 'text': text})
        idx += 1
    return entries


def _compose_scene_audio(scene_voice_map, out_audio_path, profile_cfg):
    """Generate per-scene TTS and concatenate while enforcing scene durations.

    Returns Path to the final audio file (wav).
    """
    try:
        from pydub import AudioSegment
    except Exception:
        # fallback: generate a single combined TTS blob (may mismatch durations)
        combined = "\n\n".join([text for _, _, text in scene_voice_map])
        tts_out = tts_generate(combined, str(out_audio_path), tts_engine=profile_cfg.get("tts_engine", "auto"), piper_voice=profile_cfg.get("piper_voice"))
        return Path(tts_out)

    parts = []
    for i, (name, dur, text) in enumerate(scene_voice_map):
        tmp = tempfile.NamedTemporaryFile(delete=False, suffix=f'_scene_{i}.wav')
        tmp.close()
        try:
            tts_generate(text, tmp.name, tts_engine=profile_cfg.get("tts_engine", "auto"), piper_voice=profile_cfg.get("piper_voice"))
            seg = AudioSegment.from_file(tmp.name)
            current = len(seg) / 1000.0
            target = float(dur)
            # If audio is significantly longer, speed it up
            if current > target * 1.02:
                factor = current / target
                new_frame_rate = int(seg.frame_rate * factor)
                seg = seg._spawn(seg.raw_data, overrides={"frame_rate": new_frame_rate})
                seg = seg.set_frame_rate(24000)
            # If shorter, pad with silence
            if len(seg) / 1000.0 < target:
                silence_ms = int((target - (len(seg) / 1000.0)) * 1000)
                seg = seg + AudioSegment.silent(duration=silence_ms)
            # ensure segment is exactly target seconds
            seg = seg[:int(target * 1000)]
            parts.append(seg)
        except Exception as e:
            print(f"TTS for scene {name} failed: {e}; inserting silence for {dur}s")
            parts.append(AudioSegment.silent(duration=int(dur * 1000)))
        finally:
            try:
                os.remove(tmp.name)
            except Exception:
                pass

    combined = sum(parts)
    combined.export(str(out_audio_path), format='wav')
    return Path(out_audio_path)


def fetch_headlines(rss_urls: list | None = None, max_items: int = 3) -> list:
    """Fetch top headlines from provided RSS feeds (best-effort).

    Falls back to placeholder headlines when network or parsers are unavailable.
    """
    if rss_urls is None:
        rss_urls = [
            'http://feeds.reuters.com/reuters/businessNews',
            'https://www.ft.com/?format=rss',
        ]
    headlines = []
    try:
        import feedparser
        for url in rss_urls:
            try:
                d = feedparser.parse(url)
                for e in d.get('entries', [])[:max_items]:
                    if 'title' in e:
                        headlines.append(e['title'])
                    if len(headlines) >= max_items:
                        break
            except Exception:
                continue
    except Exception:
        # feedparser not available: try requests + simple parse
        try:
            import requests
            from xml.etree import ElementTree as ET
            for url in rss_urls:
                try:
                    r = requests.get(url, timeout=4)
                    root = ET.fromstring(r.content)
                    for item in root.findall('.//item')[:max_items]:
                        t = item.find('title')
                        if t is not None and t.text:
                            headlines.append(t.text)
                        if len(headlines) >= max_items:
                            break
                except Exception:
                    continue
        except Exception:
            pass

    if not headlines:
        return [
            "Jobs report mixed; yields shifted",
            "Chip strength helped S&P",
            "Macro headlines reshaped rate bets",
        ][:max_items]
    return headlines[:max_items]



def render_video_from_scenes(scenes, audio_path, out_path, size=(720, 1280), fps=24, subtitles: list | None = None):
    clips = []
    tmp_files = []
    for i, scene in enumerate(scenes):
        # If scene provides an image, use it directly
        if scene.get('image'):
            img_path = scene['image']
        else:
            img_path = make_scene_image(scene.get("lines", []), size=size, footer=scene.get("footer"))
            tmp_files.append(img_path)
        clip = ImageClip(str(img_path)).set_duration(scene["duration"]).set_fps(fps)
        clips.append(clip)
    final = concatenate_videoclips(clips, method="compose")
    if audio_path and Path(audio_path).exists():
        final = final.set_audio(AudioFileClip(audio_path))
    # overlay bottom caption bar per-scene so captions can change per scene; also draw tiny footer always on
    from PIL import Image, ImageDraw, ImageFont
    w, h = size
    composite = final
    caption_clips = []
    try:
        try:
            footer_font = ImageFont.truetype("DejaVuSans.ttf", 20)
            caption_font = ImageFont.truetype("DejaVuSans-Bold.ttf", 36)
        except Exception:
            footer_font = ImageFont.load_default()
            caption_font = ImageFont.load_default()

        for s in scenes:
            bc = s.get('bottom_caption', '') or ''
            bar_h = 84
            bar = Image.new('RGBA', (w, bar_h), (11, 15, 18, 220))
            draw = ImageDraw.Draw(bar)
            # bottom caption centered
            if bc:
                tw, th = draw.textsize(bc, font=caption_font)
                draw.text(((w - tw) // 2, (bar_h - th) // 2), bc, font=caption_font, fill=(255, 255, 255))
            # tiny footer left
            footer = s.get('footer', '')
            if footer:
                try:
                    draw.text((12, bar_h - 20), footer, font=footer_font, fill=(200, 200, 200))
                except Exception:
                    pass
            tmp_bar = tempfile.NamedTemporaryFile(delete=False, suffix='.png')
            bar.save(tmp_bar.name)
            clip = ImageClip(tmp_bar.name).set_start(s.get('start', 0)).set_duration(s.get('duration', 1)).set_position(('center', h - bar_h))
            caption_clips.append(clip)
            tmp_files.append(tmp_bar.name)
        from moviepy.editor import CompositeVideoClip
        composite = CompositeVideoClip([final] + caption_clips)
    except Exception:
        composite = final

    # add subtitles if provided
    if subtitles:
        srt_entries = _srt_from_scenes(subtitles)
        subs = _make_subtitle_clips(srt_entries, size, fps)
        try:
            from moviepy.editor import CompositeVideoClip
            composite = CompositeVideoClip([composite] + subs)
        except Exception:
            pass

    # add animated callouts if scenes provide them
    try:
        import math
        callout_clips = []
        for s in scenes:
            for c in s.get('callouts', []) if s.get('callouts') else []:
                # c is expected to be dict with 'time' (absolute seconds) and 'text'
                text = c.get('text', '')
                start_t = float(c.get('time', s.get('start', 0)))
                dur = float(c.get('duration', 2.0))
                # create a small rounded label
                from PIL import Image, ImageDraw, ImageFont
                try:
                    ff = ImageFont.truetype("DejaVuSans-Bold.ttf", 28)
                except Exception:
                    ff = ImageFont.load_default()
                padding = 12
                tw, th = ff.getsize(text)
                w_box, h_box = tw + padding * 2, th + padding
                img = Image.new('RGBA', (w_box, h_box), (255, 204, 51, 230))
                dr = ImageDraw.Draw(img)
                dr.text((padding, (h_box - th) // 2), text, font=ff, fill=(10, 10, 10))
                tmp_label = tempfile.NamedTemporaryFile(delete=False, suffix='.png')
                img.save(tmp_label.name)
                tmp_files.append(tmp_label.name)
                label_clip = ImageClip(tmp_label.name).set_start(start_t).set_duration(dur)
                # position: default center-top area; allow override by callout.x/y
                pos = c.get('position', ('center', 'center'))
                try:
                    label_clip = label_clip.set_position(pos)
                except Exception:
                    label_clip = label_clip.set_position(('center', 'center'))
                # pulse animation (scale) using resize lambda
                try:
                    label_clip = label_clip.resize(lambda t: 1.0 + 0.08 * math.sin(10 * t))
                except Exception:
                    pass
                callout_clips.append(label_clip)
        if callout_clips:
            composite = CompositeVideoClip([composite] + callout_clips)
    except Exception:
        pass

    # ensure correct output dirs
    out_p = Path(out_path)
    out_p.parent.mkdir(parents=True, exist_ok=True)
    composite.write_videofile(str(out_p), fps=fps, codec="libx264", audio_codec="aac", threads=1)

    # cleanup tmp files
    for f in tmp_files:
        try:
            os.remove(f)
        except Exception:
            pass


def build_scenes_with_graphs(profile_cfg):
    """Build scenes exactly matching the requested 55s, 9:16 spec.

    Returns a list of scene dicts containing: name, duration, start, image/lines, bottom_caption, footer
    """
    footer = "Not financial advice."
    scenes = []

    # exact scene durations to total 55s
    scene_defs = [
        ("hook", 4.0),       # 0.0 - 4.0
        ("recap", 12.0),     # 4.0 - 16.0
        ("drivers", 14.0),   # 16.0 - 30.0
        ("risk", 10.0),      # 30.0 - 40.0 (Risk check / VIX)
        ("weekend", 12.0),   # 40.0 - 52.0
        ("base", 3.0),       # 52.0 - 55.0
    ]

    # Scene 1 — Hook
    scenes.append({
        "name": "hook",
        "lines": [("Market Wrap", True), ("Weekend Watch", True)],
        "duration": scene_defs[0][1],
        "bottom_caption": "What changed today.",
        "footer": footer,
    })

    # Scene 2 — Market close recap (SPY/QQQ split)
    hist_period = "5d"
    hist_interval = "30m"
    try:
        spy = _fetch_history("SPY", period=hist_period, interval=hist_interval)
        qqq = _fetch_history("QQQ", period=hist_period, interval=hist_interval)
        chart_recap = ensure_dirs() / "chart_recap_spyqqq.png"
        # reuse plot_spy_qqq to create the split view; plot_glow will highlight last candles
        plot_spy_qqq(spy, qqq, str(chart_recap), size=profile_cfg['size'])
        scenes.append({
            "name": "recap",
            "image": str(chart_recap),
            "duration": scene_defs[1][1],
            "bottom_caption": "Indexes ended higher.",
            "footer": footer,
            # callouts for overlay rendering/tooling
            "callouts": [
                {"time": 7.0, "text": "SPY ≈ 694"},
                {"time": 10.0, "text": "QQQ ≈ 627"},
            ],
        })
    except Exception:
        scenes.append({
            "name": "recap",
            "lines": [("Market Recap", True), ("Records into the close", False)],
            "duration": scene_defs[1][1],
            "bottom_caption": "Indexes ended higher.",
            "footer": footer,
        })

    # Scene 3 — What drove today (Headlines + mini SPX line)
    # Attempt to fetch 3 headlines from RSS (best-effort). If unavailable, use placeholders.
    headlines = []
    try:
        # very small best-effort: try to fetch an RSS if requests is available
        import requests
        from xml.etree import ElementTree as ET
        try:
            r = requests.get('https://www.reuters.com/finance', timeout=4)
            # Not guaranteed; fall back to placeholders
        except Exception:
            r = None
    except Exception:
        r = None
    if not headlines:
        headlines = ["Jobs report mixed; yields shifted", "Chip strength helped S&P", "Macro headlines reshaped rate bets"]

    try:
        spx_mini = _fetch_history("^GSPC", period="5d", interval="60m")
        chart_drivers = ensure_dirs() / "chart_drivers_headlines.png"
        plot_single(spx_mini, 'S&P 5D', str(chart_drivers), size=profile_cfg['size'])
        scenes.append({
            "name": "drivers",
            "image": str(chart_drivers),
            "duration": scene_defs[2][1],
            "bottom_caption": "Macro set the tone.",
            "footer": footer,
            "headlines": headlines[:3],
            "label": "Jobs report",
        })
    except Exception:
        scenes.append({
            "name": "drivers",
            "lines": [("Driver: Jobs data", True), (headlines[0], False)],
            "duration": scene_defs[2][1],
            "bottom_caption": "Macro set the tone.",
            "footer": footer,
            "headlines": headlines[:3],
        })

    # Scene 4 — Risk check (VIX)
    try:
        vix = _fetch_history("^VIX", period="10d", interval="60m")
        chart_vix = ensure_dirs() / "chart_vix_10d.png"
        plot_vix(vix, str(chart_vix), size=profile_cfg['size'])
        scenes.append({
            "name": "risk",
            "image": str(chart_vix),
            "duration": scene_defs[3][1],
            "bottom_caption": "VIX dropped.",
            "footer": footer,
            "vix_value": "14.49",
        })
    except Exception:
        scenes.append({
            "name": "risk",
            "lines": [("Volatility cooled", True), ("Risk premium came down", False)],
            "duration": scene_defs[3][1],
            "bottom_caption": "VIX dropped.",
            "footer": footer,
        })

    # Scene 5 — Weekend watchlist (VIX mini + 10Y yield)
    try:
        tnx = _fetch_history("^TNX", period="10d", interval="60m")
        chart_weekend = ensure_dirs() / "chart_weekend_watch.png"
        plot_vix(vix, str(ensure_dirs() / "tmp_vix.png"), size=profile_cfg['size'])
        plot_single(tnx, '10Y Yield (TNX)', str(ensure_dirs() / "tmp_tnx.png"), size=profile_cfg['size'])
        img_top = Image.open(str(ensure_dirs() / "tmp_vix.png"))
        img_bot = Image.open(str(ensure_dirs() / "tmp_tnx.png"))
        new_h = img_top.height + img_bot.height
        new_img = Image.new('RGB', (img_top.width, new_h))
        new_img.paste(img_top, (0, 0))
        new_img.paste(img_bot, (0, img_top.height))
        new_img.save(str(chart_weekend))
        scenes.append({
            "name": "weekend",
            "image": str(chart_weekend),
            "duration": scene_defs[4][1],
            "bottom_caption": "Headline risk matters most.",
            "footer": footer,
            "checklist": [
                (40.8, "Macro / geopolitics headlines"),
                (44.0, "Futures + crypto tone"),
                (47.5, "Rates direction (10Y)"),
            ],
            "tnx_label": "~4.18%",
        })
    except Exception:
        scenes.append({
            "name": "weekend",
            "lines": [("Weekend Watchlist", True), ("Sets Monday's open", False)],
            "duration": scene_defs[4][1],
            "bottom_caption": "Headline risk matters most.",
            "footer": footer,
        })

    # Scene 6 — Base case for Monday
    scenes.append({
        "name": "base",
        "lines": [("Base case: Range", True), ("Watch rotation", False)],
        "duration": scene_defs[5][1],
        "bottom_caption": "Chop until a catalyst.",
        "footer": footer,
    })

    # compute absolute start times
    cur = 0.0
    for s in scenes:
        s['start'] = cur
        cur += s['duration']
    return scenes


def main(output=None, profile: str = "smoke", use_ollama: bool = True, include_close: bool = False):
    """Main pipeline entrypoint. profile: 'smoke' or 'prod'"""
    out_dir = ensure_dirs()
    if profile not in ("smoke", "prod"):
        raise ValueError("profile must be 'smoke' or 'prod'")

    # profile-specific settings
    PROFILE_CFG = {
        "smoke": {
            "llm": "qwen2.5:1.5b",
            "tts_engine": "piper",
            "piper_voice": "en_US-lessac-medium",
            "whisper_model": "base",
            "size": (540, 960),
            "fps": 24,
            "out_name": "market_wrap_smoke.mp4",
            "include_vix": False,
            "include_tnx": False,
        },
        "prod": {
            "llm": "qwen2.5:7b",
            "tts_engine": "piper",
            "piper_voice": "en_US-lessac-hq",
            "whisper_model": "large-v3",
            "size": (1080, 1920),
            "fps": 30,
            "out_name": "market_wrap_55s.mp4",
            "include_vix": True,
            "include_tnx": True,
        },
    }

    cfg = PROFILE_CFG[profile]

    if output is None:
        output = out_dir / cfg["out_name"]
    else:
        output = Path(output)

    # Full voiceover text (word-for-word)
    voiceover = (
        "Here\'s how markets closed today — and what matters heading into the weekend. "
        "U.S. markets ended the session mixed. Indexes struggled to build momentum, with tech showing hesitation, while select defensive and value names held up better. "
        "Traders stayed cautious as yields, energy prices, and macro headlines stayed in focus. There was no major breakout — instead, we saw rotation under the surface, signaling uncertainty rather than conviction. "
        "Over the weekend, markets will be watching three key things: global macro headlines, any movement in futures or crypto, and changes in bond yields or energy prices. These will help set the tone for Monday\'s open. "
        "Unless a major catalyst hits, expect range-bound conditions to continue, with sector rotation leading rather than index direction. "
        "Follow for daily market breakdowns — no noise, just context."
    )

    print(f"Profile: {profile} — LLM={cfg['llm']}, ASR={cfg['whisper_model']}, Video={cfg['size'][0]}x{cfg['size'][1]}@{cfg['fps']}fps")

    # Optionally rewrite/condense the script using Ollama if requested
    voice_script = voiceover
    if use_ollama:
        try:
                print('Attempting Ollama rewrite to fit target duration...')
                rew = ollama_rewrite_for_duration(voiceover, target_seconds=55, model=cfg['llm'])
                if rew and rew.strip():
                    voice_script = rew
                    print('Ollama rewrite applied.')
        except Exception as e:
            print('Ollama rewrite failed or unavailable, using default script:', e)

    # Build scenes (with graphs)
    scenes = build_scenes_with_graphs(cfg)

    # Optionally remove CTA scene when include_close=False
    if not include_close:
        scenes = [s for s in scenes if s.get('name') != 'cta']

    # Map per-scene voice lines to timings (exact phrasing from spec)
    scene_text_map = {
        'hook': "Here\'s what happened in markets today — and what to watch over the weekend.",
        'recap': "Stocks finished higher Friday. The S&P 500 closed at a record 6,966, and the Nasdaq climbed to 23,671 to cap a strong week.",
        'drivers': "A mixed jobs report kept yields shifting, but the tape stayed risk-on. Reuters noted the S&P was helped by chip strength, while the jobs data shaped rate expectations.",
        'risk': "Volatility dropped — the VIX finished around 14.49, which usually signals calmer pricing into the weekend.",
        'weekend': "Into the weekend, watch headlines first. Then check futures and crypto sentiment. And keep an eye on rates — the Treasury\'s 10-year yield was about 4.18% at Friday\'s close, and a jump higher can tighten conditions fast.",
        'base': "Base case: range trade unless a weekend catalyst changes the open. Follow for the Monday setup.",
    }

    # Prepare scene_voice_map for audio composition
    scene_voice_map = [(s['name'], s['duration'], scene_text_map.get(s['name'], '')) for s in scenes if scene_text_map.get(s['name'], '')]

    # Compose per-scene audio to ensure match to scene durations
    audio_tmp = out_dir / "market_wrap_voice.wav"
    print("Generating per-scene TTS and composing audio...")
    audio_path = _compose_scene_audio(scene_voice_map, audio_tmp, cfg)
    audio_path = str(audio_path)

    # Create subtitles list from scenes
    subtitles = []
    for s in scenes:
        txt = scene_text_map.get(s['name'], '')
        if txt:
            subtitles.append((s['start'], s['start'] + s['duration'], txt))

    # Write out an SRT file as requested
    srt_path = out_dir / 'subtitles.srt'
    try:
        with open(srt_path, 'w', encoding='utf-8') as fh:
            for i, (start, end, text) in enumerate(subtitles, start=1):
                def fmt(t):
                    h = int(t // 3600)
                    m = int((t % 3600) // 60)
                    s = int(t % 60)
                    ms = int((t - int(t)) * 1000)
                    return f"{h:02}:{m:02}:{s:02},{ms:03}"
                fh.write(f"{i}\n{fmt(start)} --> {fmt(end)}\n{text}\n\n")
        print('Wrote subtitles to', srt_path)
    except Exception as e:
        print('Failed to write SRT:', e)

    # Render to a temporary video first (subtitles will be burned to final output)
    tmp_video = out_dir / 'market_wrap_nomark.mp4'
    print("Rendering video scenes to temporary file...")
    render_video_from_scenes(scenes, audio_path, str(tmp_video), size=cfg['size'], fps=cfg['fps'])

    # Burn subtitles and combine audio into final output
    final_out = out_dir / 'market_short_final.mp4'
    try:
        print("Burning subtitles into final file (ffmpeg)...")
        # Use ffmpeg to overlay subtitles; keep a copy of audio from rendered video if present
        cmd = [
            'ffmpeg', '-y',
            '-i', str(tmp_video),
            '-i', str(audio_path),
            '-c:v', 'libx264', '-c:a', 'aac',
            '-map', '0:v:0', '-map', '1:a:0',
            '-vf', f"subtitles={str(srt_path)}",
            str(final_out)
        ]
        subprocess.run(cmd, check=True)
        print('Wrote final file with burned subtitles to', final_out)
    except Exception as e:
        print('ffmpeg burn failed, falling back to non-burned output:', e)
        # fallback: move tmp_video to final_out
        try:
            os.replace(str(tmp_video), str(final_out))
            print('Moved temporary video to', final_out)
        except Exception as e2:
            print('Failed to move temporary video:', e2)

    print("Done. Output:", final_out)

    # Copy canonical deliverables to top-level `out/` as requested by the production spec
    try:
        out_root = Path("out")
        out_root.mkdir(parents=True, exist_ok=True)
        # voiceover
        try:
            Path(out_root / "voiceover.wav").write_bytes(Path(audio_path).read_bytes())
        except Exception:
            pass
        # subtitles
        try:
            Path(out_root / "subtitles.srt").write_bytes(Path(srt_path).read_bytes())
        except Exception:
            pass
        # final video
        try:
            Path(out_root / "market_short_final.mp4").write_bytes(Path(final_out).read_bytes())
        except Exception:
            pass
        print('Also copied deliverables to out/ directory')
    except Exception as e:
        print('Failed to copy deliverables to out/:', e)


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser()
    parser.add_argument("--out", default=None, help="Output mp4 file path")
    parser.add_argument("--profile", default="smoke", choices=["smoke", "prod"], help="Profile: smoke or prod")
    args = parser.parse_args()
    main(output=args.out, profile=args.profile)



